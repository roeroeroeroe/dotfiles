#!/usr/bin/env bash

output=$(cmus-remote -Q 2>/dev/null)
[ -z "$output" ] && exit

TITLE=$(echo "$output" | grep "^tag title " | cut -d " " -f 3-)
ARTIST=$(echo "$output" | grep "^tag artist " | cut -d " " -f 3-)
[[ -z "$ARTIST" || -z "$TITLE" ]] && { dunstify -r 29583 -t 2000 "Missing metadata"; exit 1; }

encode() {
	jq -nr --arg str "$1" '$str | @uri'
}

URI="https://api.lyrics.ovh/v1/$(encode "$ARTIST")/$(encode "$TITLE")"
RES=$(curl -s "$URI")
LYRICS=$(echo "$RES" | jq -r '.lyrics')
[ "$LYRICS" = "null" ] && { dunstify -r 29583 -t 2000 "Lyrics not found"; exit 1; }

TEMP=$(mktemp /tmp/lyrics.XXXXX)
echo "$LYRICS" > $TEMP
st -e nvim $TEMP
rm $TEMP
