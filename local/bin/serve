#!/usr/bin/env bash

file="$1"
port="20154"
addr="$(ip route get 1.2.3.4 | cut -d' ' -f 7)"

[ ! -f "$file" ] && { echo "File does not exist"; exit 1; }

date=$(date +"%a, %d %b %Y %H:%M:%S %Z")
size=$(du -b "$file" | awk '{print $1}')

header="HTTP/1.1 200 OK\r\n\
Server: Netcat File Server\r\n\
Date: $date\r\n\
Content-type: application/octet-stream\r\n\
Content-Length: $size\r\n\
Connection: close\r\n\
Content-Disposition: attachment; filename=\"$(basename "$file")\"\r\n
Last Modified: $date\r\n\r\n"

shout() {
	printf "%s$header"
	cat "$file"
	printf "%s\c"
}

trap "exit" SIGINT

while true; do
	printf "\033[1;32mServing $file ($size bytes) on http://$addr:$port\033[0m\n"
	shout | nc -l -p $port
done
