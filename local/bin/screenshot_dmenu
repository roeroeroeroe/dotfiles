#!/usr/bin/env bash

ordered=("desktop" "area" "window" "capture in 5s" "ocr")
declare -A commands=(
	["desktop"]="shotnow"
	["area"]="shotarea"
	["window"]="shotwin"
	["capture in 5s"]="shot5"
	["ocr"]="ocr"
)

dir="$(xdg-user-dir PICTURES)/Screenshots"
file="$(date +%Y-%m-%d-%H-%M-%S).png"
[ ! -d "$dir" ] && mkdir -p "$dir"

copy_shot() {
	tee "$file" | xclip -se c -t image/png
}

shotnow() {
	sleep 0.5; cd "${dir}" && maim -f png -u | copy_shot
}

shot5() {
	for i in {5..1}; do
		dunstify -r 5009 -t 1025 "Taking shot in "$i"s"
		sleep 1
	done
	sleep 1.25; cd "${dir}" && maim -f png -u | copy_shot
}

shotwin() {
	sleep 0.5; cd "${dir}" && maim -f png -ui "$(xdotool getactivewindow)" | copy_shot
}

shotarea() {
	sleep 0.5; cd "${dir}" && maim -f png -souc 0.84,0.37,0.06 | copy_shot
}

ocr() {
	TEMP=$(mktemp /tmp/ocr.XXXXX.png)
	maim -souc 0.84,0.37,0.06 > "$TEMP" || { rm "$TEMP"; exit; }
	tesseract "$TEMP" - -l eng 2>/dev/null | xclip -se c
	rm "$TEMP"
}

choice=$(printf "%s\n" "${ordered[@]}" | dmenu -l 5 2>/dev/null)
if [ -n "${commands[$choice]}" ]; then
	eval "${commands[$choice]}"
	dunstify -r 5009 -t 2000 "Copied to clipboard"
fi
