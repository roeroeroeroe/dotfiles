#!/usr/bin/env bash

[ -p /dev/stdin ] && stdin=$(</dev/stdin) || stdin=""
prompt="${*}${stdin:+${*:+ }${stdin}}"

[ -z "$prompt" ] && { echo "Usage: $(basename "$0") <prompt>"; exit 1; }

TASK=$(curl -s -X POST https://nexra.aryahcr.cc/api/chat/gpt \
	-H "Content-Type: application/json" \
	-d "$(jq -n --arg prompt "$prompt" \
		'{
			prompt: $prompt,
			model: "gpt-4",
			markdown: false
		}'
	)"
)

TASK_ID=$(echo "$TASK" | jq -r '.id')
[[ -z "$TASK_ID" || "$TASK_ID" == "null" ]] && { echo "No task id in response, exiting"; exit 1; }

STATUS="pending"
while [ "$STATUS" = "pending" ]; do
	RESPONSE=$(curl -s -X GET "https://nexra.aryahcr.cc/api/chat/task/$TASK_ID" \
		-H "Content-Type: application/json"
	)

	STATUS=$(echo "$RESPONSE" | jq -r '.status')
	case "$STATUS" in
		"pending") sleep 0.5 ;;
		"completed") echo "$RESPONSE" | jq -r '.gpt' ;;
		"error" | "not_found") echo "Error (status: $STATUS)"; exit 1 ;;
		*) echo "Unexpected status ($STATUS)"; exit 1 ;;
	esac
done
