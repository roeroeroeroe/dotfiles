#!/usr/bin/env bash

[ "$1" = "-h" ] && {
	echo "Usage: ${0##*/} [-s]
  -s   print artist-title slug and exit"
	exit 0
}

DATA=$(cmus-remote -Q 2>/dev/null)
[ -z "$DATA" ] && {
	notify-send "cmus is not running"
	exit 1
}

TITLE=$(echo "$DATA" | grep "^tag title " | cut -d " " -f 3-)
ARTIST=$(echo "$DATA" | grep "^tag artist " | cut -d " " -f 3-)
[[ -z "$ARTIST" || -z "$TITLE" ]] && { notify-send "missing metadata"; exit 1; }

LYRICS_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/lyrics"

encode() {
	jq -sRr @uri <<< "$@"
}

slug() {
	echo "$@" | iconv -t ascii//TRANSLIT | tr "[:upper:]" "[:lower:]" | sed \
		-e "s/&/and/g" \
		-e "s/[[:space:]:$/]\+/-/g" \
		-e "s/[^a-z0-9-]//g"
}

ARTIST_TITLE_SLUG="$(slug "$ARTIST")-$(slug "$TITLE")"
LYRICS_FILE="$LYRICS_DIR/$ARTIST_TITLE_SLUG"

[ "$1" = "-s" ] && {
	echo "$ARTIST_TITLE_SLUG"
	exit 0
}

write_lyrics() {
	[ -z "$1" ] && return 1
	[ -d "$LYRICS_DIR" ] || mkdir -p "$LYRICS_DIR"
	[ -f "$LYRICS_FILE" ] && return 0

	echo "$1" > "$LYRICS_FILE"
	return 0
}

lyrics_api() {
	URL="https://api.lyrics.ovh/v1/$(encode "$ARTIST")/$(encode "$TITLE")"
	LYRICS=$(curl -sLm 3 "$URL" | jq -r '.lyrics // empty')

	write_lyrics "$LYRICS"
	return
}

genius() {
	URL="https://genius.com/$ARTIST_TITLE_SLUG-lyrics"
	LYRICS=$(curl -sLm 10 "$URL" | pup 'div[data-lyrics-container="true"] text{}' | sed \
		-e 's/<[^>]*>//g' \
		-e 's/&#39;/'"'"'/g' \
		-e 's/&#34;/"/g' \
		-e 's/^[ \t]*//;s/[ \t]*$//')

	write_lyrics "$LYRICS"
	return
}

[ -f "$LYRICS_FILE" ] || genius || lyrics_api || {
	notify-send "lyrics not found"
	exit
}

st -e ${EDITOR:-vim} "$LYRICS_FILE"
