#!/usr/bin/env bash

OUT=""
API="api.ipify.org"
TIMED_OUT="Request timed out"
DOWN="Proxy connection failed"
NOTIFICATION_TITLE="API used: $API"

declare -A PORTS=(
	[2080]="vless"
	[9050]="tor"
)

get_down_str () {
	[[ "$1" == *"Connection timed out"* ]] && echo "Down ($TIMED_OUT)" || echo "Down ($DOWN)"
}

for PORT in ${!PORTS[@]}; do
	PROXY=${PORTS[$PORT]}
	RESPONSE=$(curl -s -m 3 -x socks4://127.0.0.1:$PORT $API 2>&1)
	[[ $? -eq 0 ]] && OUT="$OUT$PROXY: Up ($RESPONSE)\n" || OUT="$OUT$PROXY: $(get_down_str $RESPONSE)\n"
done

RESPONSE=$(curl -s -m 3 $API 2>&1)
[[ $? -eq 0 ]] && OUT="$OUT\direct: Up ($RESPONSE)" || OUT="$OUT\direct: $(get_down_str $RESPONSE)\n"

dunstify -r 9965 -t 10000 "$NOTIFICATION_TITLE" "$OUT"

