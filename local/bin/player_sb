#!/usr/bin/env bash

TITLE_MAX_LEN=25
PLAYING_ICON="󰐊"
PAUSED_ICON="󰏤"

handle_cmus() {
	local data="$1"
	local status="" dur=0 pos=0 title=""
	local line
	while IFS= read -r line; do
		case "$line" in
			status\ *)
				status=${line#status }
				[ "$status" = "stopped" ] && exit 0
				;;
			duration\ *)
				dur=${line#duration }
				;;
			position\ *)
				pos=${line#position }
				;;
			tag\ title\ *)
				title=${line#tag title }
				;;
		esac
	done <<< "$data"

	local icon=""
	case "$status" in
		playing) icon="$PLAYING_ICON" ;;
		paused) icon="$PAUSED_ICON" ;;
	esac

	[ ${#title} -gt $TITLE_MAX_LEN ] && title="${title:0:TITLE_MAX_LEN}..."

	printf "%s %02d:%02d/%02d:%02d %s" \
		"$icon" \
		$((pos / 60)) $((pos % 60)) $((dur / 60)) $((dur % 60)) \
		"$title"
}

cmus_data="$(cmus-remote -Q 2> /dev/null)" && \
	{ handle_cmus "$cmus_data"; exit 0; }

pc_out="$(playerctl metadata --format '{{status}}|{{title}}' 2> /dev/null)"
pc_title="${pc_out#*|}"
case "${pc_out%%|*}" in
	Playing) icon="$PLAYING_ICON" ;;
	Paused) icon="$PAUSED_ICON" ;;
	*) icon="" ;;
esac

[ ${#pc_title} -gt $TITLE_MAX_LEN ] && pc_title="${pc_title:0:TITLE_MAX_LEN}..."
printf "%s %s" \
	"$icon" "$pc_title"
