#!/usr/bin/env bash

CLIENT_ID="ue6666qo983tsx6so1t0vnawi233wa"
SCOPES="analytics:read:extensions analytics:read:games bits:read channel:bot \
channel:edit:commercial channel:manage:ads channel:manage:broadcast \
channel:manage:extensions channel:manage:guest_star channel:manage:moderators \
channel:manage:polls channel:manage:predictions channel:manage:raids \
channel:manage:redemptions channel:manage:schedule channel:manage:videos \
channel:manage:vips channel:moderate channel:read:ads channel:read:charity \
channel:read:editors channel:read:goals channel:read:guest_star \
channel:read:hype_train channel:read:polls channel:read:predictions \
channel:read:redemptions channel:read:stream_key channel:read:subscriptions \
channel:read:vips chat:edit chat:read clips:edit moderation:read \
moderator:manage:announcements moderator:manage:automod \
moderator:manage:automod_settings moderator:manage:banned_users \
moderator:manage:blocked_terms moderator:manage:chat_messages \
moderator:manage:chat_settings moderator:manage:guest_star \
moderator:manage:shield_mode moderator:manage:shoutouts \
moderator:manage:unban_requests moderator:manage:warnings \
moderator:read:automod_settings moderator:read:blocked_terms \
moderator:read:chat_settings moderator:read:chatters moderator:read:followers \
moderator:read:guest_star moderator:read:moderators moderator:read:shield_mode \
moderator:read:shoutouts moderator:read:suspicious_users \
moderator:read:unban_requests moderator:read:vips user:bot user:edit \
user:edit:broadcast user:edit:follows user:manage:blocked_users \
user:manage:chat_color user:manage:whispers user:read:blocked_users \
user:read:broadcast user:read:chat user:read:email user:read:emotes \
user:read:follows user:read:moderated_channels user:read:subscriptions \
user:write:chat whispers:edit whispers:read"

oauth_request() {
	URL="$1"
	shift
	PAYLOAD="$@"
	curl -sX POST "$URL" \
		-d "$PAYLOAD" \
		-H "Content-Type: application/x-www-form-urlencoded"
	return
}

DEVICE_CODE_RESPONSE=$(oauth_request \
	"https://id.twitch.tv/oauth2/device" \
	"client_id=$CLIENT_ID&scopes=$SCOPES"
)

[ $? -ne 0 ] && {
	echo "error getting device code"
	exit 1
}

USER_CODE="$(jq -r '.user_code // empty' <<< "$DEVICE_CODE_RESPONSE")"
DEVICE_CODE="$(jq -r '.device_code // empty' <<< "$DEVICE_CODE_RESPONSE")"

[[ -z "$USER_CODE" || -z "$DEVICE_CODE" ]] && {
	echo "empty response"
	exit 1
}

EXPIRES_IN="$(jq -r '.expires_in // empty' <<< "$DEVICE_CODE_RESPONSE")"
EXPIRES_IN="${EXPIRES_IN:-1800}"

INTERVAL="$(jq -r '.interval // empty' <<< "$DEVICE_CODE_RESPONSE")"
INTERVAL="${INTERVAL:-5}"

EXPIRES_AT=$(( $(date +%s) + EXPIRES_IN ))

echo "https://www.twitch.tv/activate
code: $USER_CODE (expires in $((EXPIRES_IN / 60)) minutes)"

while :; do
	sleep "$INTERVAL"
	[ $(date +%s) -ge $EXPIRES_AT ] && {
		echo "code expired"
		exit 1
	}

	TOKEN_RESPONSE=$(oauth_request \
		"https://id.twitch.tv/oauth2/token" \
		"client_id=$CLIENT_ID&device_code=$DEVICE_CODE&grant_type=urn:ietf:params:oauth:grant-type:device_code"
	)

	jq -e '.access_token' <<< "$TOKEN_RESPONSE" &> /dev/null && break
done

echo "$TOKEN_RESPONSE"
