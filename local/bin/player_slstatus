#!/usr/bin/env bash

fmt_s() {
	printf "%02d:%02d" "$(( $1 / 60 ))" "$(( $1 % 60 ))"
}

handle_cmus() {
	output=$1
	status=$(echo "$output" | grep -m 1 "^status " | cut -d " " -f 2-)
	[ "$status" = "stopped" ] && exit

	case "$status" in
		"playing") icon="󰐊" ;;
		"paused") icon="󰏤" ;;
		*) icon="" ;;
	esac

	duration=$(echo "$output" | grep -m 1 "^duration " | cut -d " " -f 2-)
	position=$(echo "$output" | grep -m 1 "^position " | cut -d " " -f 2-)
	timestamp="$(fmt_s "$position")/$(fmt_s "$duration")"

	title=$(echo "$output" | grep "^tag title " | cut -d " " -f 3-)
	[ "${#title}" -gt 20 ] && title="${title:0:20} ..."

	echo "$icon [$timestamp] $title"
}

handle_playerctl() {
	status=$1
	[ -z "$status" ] && exit

	case "$status" in
		"Playing") icon="󰐊" ;;
		"Paused") icon="󰏤" ;;
		*) icon="" ;;
	esac

	title=$(playerctl metadata title)
	[ "${#title}" -gt 20 ] && title="${title:0:20} ..."

	echo "$icon $title"
}

output=$(cmus-remote -Q 2>/dev/null)
if [ -n "$output" ]; then
	handle_cmus "$output"
else
	handle_playerctl "$(playerctl status 2>/dev/null)"
fi
